name: Playlist Automation

on:
  issues:
    types: [labeled]

jobs:
  generate-playlist:
    if: github.event.label.name == 'playlist-idea'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
    
    steps:
      - name: Invoke Copilot Coding Agent
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            const issueTitle = context.payload.issue.title.replace('[PLAYLIST] ', '');
            const issueNumber = context.issue.number;
            
            const themeMatch = issueBody.match(/## Playlist Theme\s*(?:<!--.*?-->\s*)?(.*?)(?=\n##|\n---|\z)/s);
            const samplesMatch = issueBody.match(/## Sample Songs\/Artists\s*(?:<!--.*?-->\s*)?(.*?)(?=\n##|\n---|\z)/s);
            
            const theme = themeMatch ? themeMatch[1].trim() : issueTitle;
            const samplesList = samplesMatch ? samplesMatch[1].trim().split('\n').filter(l => l.trim().startsWith('-')).slice(0, 5).join('\n') : 'See issue';
            const filename = theme.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
            
            const message = `ðŸŽµ **Playlist request received!**

#github-pull-request_copilot-coding-agent please create this power hour playlist:

**Theme:** ${theme}

**Sample tracks:**
${samplesList}

**Task:** Create a 60-song power hour for this theme. Check the full issue description above for all details.

**Steps:**
1. Research 60 songs matching this theme
2. Find official YouTube music videos (studio versions only)
3. Create CSV: input/${filename}_list.csv (columns: id, title, start)
4. Generate HTML: python -m power_hour.cli build-youtube-html input/${filename}_list.csv output/${filename}_power_hour.html --clip-seconds 60 --title-reveal-delay 20 --no-shuffle --default-start 15
5. Run tests: pytest tests/
6. Create PR titled "Add ${theme} Power Hour Playlist" linked to issue #${issueNumber}
7. Close this issue when PR merges

**Important:** NO &start_radio=1 URLs. Use curl to verify each video. Follow README.md verification steps.`;
            
            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
