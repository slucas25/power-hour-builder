name: Playlist Automation

on:
  issues:
    types: [labeled]

jobs:
  generate-playlist:
    if: github.event.label.name == 'playlist-idea'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write
    
    steps:
      - name: Invoke Copilot Coding Agent
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            const issueTitle = context.payload.issue.title.replace('[PLAYLIST] ', '');
            const issueNumber = context.issue.number;
            
            const themeMatch = issueBody.match(/## Playlist Theme\s*(?:<!--.*?-->\s*)?(.*?)(?=\n##|\n---|\z)/s);
            const samplesMatch = issueBody.match(/## Sample Songs\/Artists\s*(?:<!--.*?-->\s*)?(.*?)(?=\n##|\n---|\z)/s);
            
            const theme = themeMatch ? themeMatch[1].trim() : issueTitle;
            const samplesList = samplesMatch ? samplesMatch[1].trim().split('\n').filter(l => l.trim().startsWith('-')).slice(0, 5).join('\n') : 'See issue';
            const filename = theme.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
            
            const message = 'ðŸŽµ Playlist request received!\n\n' +
              '#github-pull-request_copilot-coding-agent please create this power hour playlist:\n\n' +
              'Theme: ' + theme + '\n\n' +
              'Sample tracks:\n' + samplesList + '\n\n' +
              'Task: Create a 60-song power hour for this theme. Check the full issue description above for all details.\n\n' +
              'CRITICAL STEPS (ALL REQUIRED):\n' +
              '1. Research 60 songs matching this theme\n' +
              '2. Find YouTube videos with this priority order:\n' +
              '   a) Official music video (studio version) - PREFERRED\n' +
              '   b) Official live performance - if official music video not available\n' +
              '   c) High-quality unofficial video - only as last resort\n' +
              '3. Create CSV file: input/' + filename + '_list.csv (columns: id, title, start)\n' +
              '4. REQUIRED - Generate HTML player file using this EXACT command:\n' +
              '   python -m power_hour.cli build-youtube-html --urls-csv input/' + filename + '_list.csv --output output/' + filename + '_power_hour.html --clip-seconds 60 --title-reveal-delay 20 --no-shuffle --default-start 15\n' +
              '5. Verify HTML file exists: ls -la output/' + filename + '_power_hour.html\n' +
              '6. Run tests: pytest tests/\n' +
              '7. Commit BOTH files: git add input/' + filename + '_list.csv output/' + filename + '_power_hour.html\n' +
              '8. Create PR with description that includes: "Closes #' + issueNumber + '"\n' +
              '   Title: "Add ' + theme + ' Power Hour Playlist"\n' +
              '   Body must contain: Closes #' + issueNumber + ' (this auto-closes the issue when PR merges)\n\n' +
              'Important: NO &start_radio=1 URLs. Use curl to verify each video. Follow README.md verification steps.';
            
            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
